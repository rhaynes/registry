
var db = require('registry/db');
var stripe = require('registry/stripe');

function processPayment($P, chargeobj, uid, cb) {
  console.log("trying to charge customer...");
  console.log("chargeobj: ",chargeobj);
  try {
    var res = stripe.charges.create(chargeobj);
  } catch(e) {
    var msg = JSON.parse(e.message);
    if (msg.rawType == 'card_error') {
      $P.error(new Error(msg.message));
    } else {
      db.errors.add('Stripe Error','Stripe API error in processing payment.');
      $P.error(new Error('The server is temporarily overwhelmed with traffic. Please do not try entering your card twice. If this happens again, please let the registry owner know.'));
    }
  }

  //***** AT THIS POINT, THE CREDIT CARD HAS BEEN CHARGED SUCCESSFULLY *****\\
  //***** Now it's up to the purchase controller to make sure the user gets what he/she paid for *****\\
  cb(res);
}

// Amount to charge to user in USD cents
exports.charge = function($P,amount,cb) {
  var chargeobj = {
    amount: amount,
    currency: 'usd',
    description: '{email: '+$P.args.gift.email+'}',
  }

  chargeobj.card = $P.args.ccToken;
  processPayment($P, chargeobj, $P.userID, cb);
}

